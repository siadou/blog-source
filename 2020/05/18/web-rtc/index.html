<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="lemonkun"><title>WebRTC技术原理 · 绝好调超</title><meta name="description" content="最近在用Sip.JS实现网络软电话的功能，于是抽时间了解了下WebRTC的相关原理。

WebRTC (Web Real-Time Communications) 是一项实时通讯技术，它允许网络应用或者站点，在不借助中间媒介的情况下，建立浏览器之间点对点（Peer-to-Peer）的连接，实现视频流"><meta name="keywords" content="前端技术,生活,游戏,动画"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title><a href="/">绝好调超</a></h3><div class="description"><p>十分钟热度</p></div></div></div><ul class="social-links"></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/about">关于</a></li><li><a href="/archives">归档</a></li><li><a href="/links">友链</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="https://tvax2.sinaimg.cn/crop.115.16.155.155.180/4a970e85ly8fnyjabf72fj20b408c749.jpg"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>WebRTC技术原理</a></h3></div><div class="post-content"><blockquote>
<p>最近在用Sip.JS实现网络软电话的功能，于是抽时间了解了下WebRTC的相关原理。</p>
</blockquote>
<p>WebRTC (Web Real-Time Communications) 是一项实时通讯技术，它允许网络应用或者站点，在不借助中间媒介的情况下，建立浏览器之间点对点（Peer-to-Peer）的连接，实现视频流和（或）音频流或者其他任意数据的传输。WebRTC包含的这些标准使用户在无需安装任何插件或者第三方的软件的情况下，创建点对点（Peer-to-Peer）的数据分享和电话会议成为可能。</p>
<p>WebRTC是一个完全对等技术，用于实时交换音频、视频和数据，同时提供一个中心警告。如其他地方所讨论的，必须进行一种发现和媒体格式协商，以使不同网络上的两个设备相互定位。这个过程被称为信令，并涉及两个设备连接到第三个共同商定的服务器。通过这个第三方服务器，这两台设备可以相互定位，并交换协商消息。</p>
<p>常见应用包括：SIP协议实现web电话，web torrent，视频会议等。</p>
<h1 id="ICE框架协议栈"><a href="#ICE框架协议栈" class="headerlink" title="ICE框架协议栈"></a>ICE框架协议栈</h1><p>Interactive Connectivity Establishment (ICE)是一个允许你的浏览器和对端浏览器建立连接的协议框架(不是一个协议)。在实际的网络当中，有很多原因能导致简单的从A端到B端直连不能如愿完成。这需要绕过阻止建立连接的防火墙，给你的设备分配一个唯一可见的地址（通常情况下我们的大部分设备没有一个固定的公网地址），如果路由器不允许主机直连，还得通过一台服务器转发数据。</p>
<p>ICE协议只是制定规范，没规定怎么实现细节，Google的WebRTC是ICE的实现。</p>
<p>ICE整合了STUN、TURN，通过使用以下几种技术完成上述工作：</p>
<h2 id="NAT"><a href="#NAT" class="headerlink" title="NAT"></a>NAT</h2><p>网络地址转换协议Network Address Translation (NAT) 用来给局域网设备映射一个公网的IP地址的协议。一般情况下，路由器的WAN口有一个公网IP，所有连接这个路由器LAN口的设备会分配一个私有网段的IP地址（例如192.168.1.3）。私网设备的IP被映射成路由器的公网IP和唯一的端口，通过这种方式不需要为每一个私网设备分配不同的公网IP，但是依然能被外网设备发现。</p>
<p>一些路由器严格地限定了部分私网设备的对外连接。这种情况下，即使STUN服务器识别了该私网设备的公网IP和端口的映射，依然无法和这个私网设备建立连接。这种情况下就需要转向TURN协议。</p>
<h2 id="STUN"><a href="#STUN" class="headerlink" title="STUN"></a>STUN</h2><p>NAT的会话穿越功能Session Traversal Utilities for NAT (STUN) (缩略语的最后一个字母是NAT的首字母)是一个允许位于NAT后的客户端找出自己的公网地址，判断出路由器阻止直连的限制方法的协议。<br>STUN服务器位于公网上并且有一个简单的任务：检查传入请求的IP和端口地址（来自在NAT网络中运行的应用程序）并将该地址作为响应发回。换句话说，应用程序使用STUN服务器查询其位于公网上的IP和端口。此过程使WebRTC端点能够查询到自己公开访问的地址，然后通过信令机制将其传递给另一个端点，以便建立直接链接。（事实上，不同的NAT以不同的方式工作，并且可能存在多个NAT层，但原理仍然是相同的）。<br>客户端通过给公网的STUN服务器发送请求获得自己的公网地址信息，以及是否能够被（穿过路由器）访问。</p>
<p><img src="/images/web-rtc/stun.png" alt></p>
<h2 id="TURN"><a href="#TURN" class="headerlink" title="TURN"></a>TURN</h2><p>一些路由器使用一种“对称型NAT”的NAT模型。这意味着路由器只接受和对端先前建立的连接（就是下一次请求建立新的连接映射）。TURN是对STUN的扩展。</p>
<p>NAT的中继穿越方式Traversal Using Relays around NAT (TURN) 通过TURN服务器中继所有数据的方式来绕过“对称型NAT”。你需要在TURN服务器上创建一个连接，然后告诉所有对端设备发包到服务器上，TURN服务器再把包转发给你。很显然这种方式是开销很大的，所以只有在迫不得已的情况下采用。</p>
<p>TURN与STUN的共同点都是通过修改应用层中的私网地址达到NAT穿透的效用，异同点是TURN采用了两方通讯的“中间人”方式实现穿透，突破了原先STUN协议无法在两台主机不能够点对点直接连接下提供作用的限制。</p>
<p><img src="/images/web-rtc/turn.png" alt></p>
<h2 id="SDP"><a href="#SDP" class="headerlink" title="SDP"></a>SDP</h2><p>会话描述协议Session Description Protocol (SDP) 是一个描述多媒体连接内容的协议，例如分辨率，格式，编码，加密算法等。所以在数据传输时两端都能够理解彼此的数据。本质上，这些描述内容的元数据并不是媒体流本身。</p>
<p>从技术上讲，SDP并不是一个真正的协议，而是一种回话描述格式，用于描述在设备之间共享媒体的连接。</p>
<h2 id="SDP报文格式"><a href="#SDP报文格式" class="headerlink" title="SDP报文格式"></a>SDP报文格式</h2><p>SDP描述由许多文本行组成，文本行的格式为&lt;类型&gt;=&lt;值&gt;，&lt;类型&gt;是一个字母，&lt;值&gt;是结构化的文本串，其格式依&lt;类型&gt;而定。详见在RFC 2327。</p>
<p><strong>＜type＞=<value>[CRLF]</value></strong></p>
<p>一个SDP会话描述包含如下部分:</p>
<ol>
<li>会话名称和会话目的</li>
<li>会话的激活时间</li>
<li>构成会话的媒体(media)</li>
<li>为了接收该媒体所需要的信息(如地址,端口,格式等)<br>因为在中途参与会话也许会受限制,所以可能会需要一些额外的信息:</li>
<li>会话使用的的带宽信息</li>
<li>会话拥有者的联系信息</li>
</ol>
<p><img src="/images/web-rtc/sdp.png" alt></p>
<h3 id="SDP交换模型-——-Offer-Answer模型"><a href="#SDP交换模型-——-Offer-Answer模型" class="headerlink" title="SDP交换模型 —— Offer/Answer模型"></a>SDP交换模型 —— Offer/Answer模型</h3><p>上文说到,SDP用来描述多播主干网络的会话信息,但是并没有具体的交互操作细节是如何实现的,因此RFC3264定义了一种基于SDP的offer/answer模型.在该模型中,会话参与者的其中一方生成一个SDP报文构成offer,其中包含了一组offerer希望使用的多媒体流和编解码方法,以及offerer用来接收改数据的IP地址和端口信息.offer传输到会话的另一端(称为answerer),由answerer生成一个answer,即用来响应对应offer的SDP报文.answer中包含不同offer对应的多媒体流,并指明该流是否可以接受.</p>
<p>RFC3264只介绍了交换数据过程,而没有定义传递offer/answer报文的方法,一种实现是RFC3261/SIP即会话初始化协议中描述。</p>
<h2 id="ICE工作流程"><a href="#ICE工作流程" class="headerlink" title="ICE工作流程"></a>ICE工作流程</h2><p>ICE的基本思路是,每个终端都有一系列传输地址(包括传输协议,IP地址和端口)的候选,可以用来和其他端点进行通信.<br>其中可能包括:</p>
<ol>
<li>直接和网络接口联系的传输地址(host address)</li>
<li>经过NAT转换的传输地址,即反射地址(server reflective address)</li>
<li>TURN服务器分配的中继地址(relay address)</li>
</ol>
<p>虽然潜在要求任意一个Peer的候选地址都能用来和Peer的候选地址进行通信。但是实际中发现有许多组合是无法工作的.举例来说,如果A和B都在NAT之后而且不处于同一内网,他们的直接地址就无法进行信.ICE的目的就是为了发现哪一对候选地址的组合可以工作,并且通过系统的方法对所有组合进行测试(用一种精心挑选的顺序).</p>
<p><img src="/images/web-rtc/ice.png" alt></p>
<p>如图所示，A想与B进行通信，过程如下：</p>
<ol>
<li>A收集所有的IP地址，并找出其中可以从STUN服务器和TURN服务器收到流量的地址；</li>
<li>A向STUN服务器发送一份地址列表，然后按照排序的地址列表向B发送启动信息，目的是实现节点间的通信；</li>
<li>B向启动信息中的每一个地址发送一条STUN请求；</li>
<li>A将第一条接收到的STUN请求的回复信息发送给B；</li>
<li>B接到STUN回复后，从中找出那些可在A和B之间实现通信的地址；</li>
<li>利用列表中的排序列最高的地址进一步的设备间通信。</li>
</ol>
<p>由于该技术是建立在多种NAT穿透协议的基础之上，并且提供了一个统一的框架，所以ICE具备了所有这些技术的优点，同时还避免了任何单个协议可能存在的缺陷。因此，ICE可以实现在未知网络拓扑结构中实现的设备互连，而且不需要进行对手配置。另外，由于该技术不需要为VoIP流量手动打开防火墙，所以也不会产生潜在的安全隐患。</p>
<h1 id="实体"><a href="#实体" class="headerlink" title="实体"></a>实体</h1><h2 id="会话描述"><a href="#会话描述" class="headerlink" title="会话描述"></a>会话描述</h2><p>WebRTC连接上的端点配置称为会话描述。<br>该描述包括关于要发送的媒体类型，其格式，正在使用的传输协议，端点的IP地址和端口以及描述媒体传输端点所需的其他信息的信息。 使用会话描述协议(SDP)来交换和存储该信息; 如果您想要有关SDP数据格式的详细信息，可以中找到。</p>
<h2 id="信令"><a href="#信令" class="headerlink" title="信令"></a>信令</h2><p>信令用于协调通信，WebRTC应用开始通话之前，客户端需要交换一些信息（信令）：<br>用于打开或关闭通信的会话控制消息，如：</p>
<ol>
<li>错误信息。</li>
<li>媒体元数据，例如编解码器和编解码器设置，带宽和媒体类型。</li>
<li>用于建立安全连接的的秘钥信息。</li>
<li>主机的IP和端口等网络信息。<br>（以上部分信息以SDP形式传递）为了避免冗余并提高与已有技术的兼容性，WebRTC标准未规定信令方法和协议。JavaScript会话建立协议（JSEP）描述了一种大致的方法：</li>
</ol>
<p>WebRTC没有规定信令层的协议。这是因为不同的应用程序可能更喜欢使用不同的信令协议，比如已经存在的SIP或者Jingle信令协议，抑或一些针对应用定制的协议。在这种方法中，需要交换的关键信息是多媒体会话描述（SDP），它指定了建立媒体连接所必需的传输和媒体配置信息。</p>
<p>JSEP需要在 offer / 提议 和 answer / 应答 的点与点之间交换上文提到的媒体元数据信息。交换信息的两个点之间使用SDP会话描述协议进行通信。SDP协议消息格式大概是这个样子：</p>
<p>常用信令扩展：<br>XMPP（可扩展消息传递和呈现协议）：基于XML为即时消息传递开发的可用于信令的协议。<br>开源库，如ZeroMQ和OpenMQ。NullMQ使用基于WebSocket的STOMP协议将ZeroMQ概念应用于Web平台。<br>使用WebSocket的商业云消息传递平台，例如Pusher，Kaazing和PubNub。<br>商业WebRTC平台，如vLine。</p>
<h2 id="信令服务器"><a href="#信令服务器" class="headerlink" title="信令服务器"></a>信令服务器</h2><p>两个设备之间建立WebRTC连接需要一个信令服务器来实现双方通过网络进行连接。<br>信令服务器并不需要理解和解释信令数据内容。通过信令服务器的消息的内容实际上是一个黑盒。重要的是，交换两点之间传递的信令。内容对其来讲并不重要。<br>client到信令服务器需要双向通信，所以最简单的实现是websocket。其他可以采用轮询、长轮询等方法。<br>信令服务器不传递Media信息。</p>
<h2 id="ICE候选"><a href="#ICE候选" class="headerlink" title="ICE候选"></a>ICE候选</h2><p>除了交换关于媒体的信息(上面提到的Offer / Answer和SDP )中，对等体必须交换关于网络连接的信息。 这被称为ICE候选者，并详细说明了对等体能够直接或通过TURN服务器进行通信的可用方法。 通常，每个同伴将首先提出最佳候选人，让他们走向更糟糕的候选人。 理想情况下，候选地址是UDP(因为速度更快，媒体流能够相对容易地从中断恢复 )，但ICE标准也允许TCP候选。</p>
<h1 id="通信过程"><a href="#通信过程" class="headerlink" title="通信过程"></a>通信过程</h1><p>RTCPeerConnection是WebRTC应用程序在点对点之间创建连接并传送音频和视频的API。<br>要想创建音视频通信连接，RTCPeerConnection有两个任务：</p>
<ol>
<li>确定本地媒体信息，例如分辨率和编解码器信息。这是用于offer和answer机制的元数据。</li>
<li>获取应用程序主机的网络地址，称为candidate。</li>
</ol>
<p><img src="/images/web-rtc/connection.png" alt></p>
<p>offer/answer过程：</p>
<ol>
<li>Alice创建了一个RTCPeerConnection对象。</li>
<li>Alice使用RTCPeerConnection的createOffer()方法创建了一个offer（一个SDP会话描述文本）。</li>
<li>Alice调用setLocalDescription()将她的offer设置为本地描述。</li>
<li>Alice把offer转换为字符串，并使用信令机制将其发送给Eve。</li>
<li>Eve对Alice的offer调用setRemoteDescription()函数，为了让他的RTCPeerConnection知道Alice的设置。</li>
<li>Eve调用createAnswer()函数创建answer。</li>
<li>Eve通过调用setLocalDescription()将自己的answer设置为本地描述。</li>
<li>Eve使用信令机制把自己字符串化的的answer传给Alice。</li>
<li>Alice使用setRemoteDescription()函数将Eve的answer设置为远程会话描述。</li>
</ol>
<p>Alice和Eve也需要去交换网络信息。“查找候选地址candidate”一词是指使用ICE框架查找网络接口和端口的过程。</p>
<ol>
<li>Alice创建RTCPeerConnection对象的时候会生成一个onicecandidate句柄。</li>
<li>这个句柄在网络candidate生效时会被调用。</li>
<li>Alice通过信令通道将字符串化的candidate数据发送给Eve。<br>当Eve从Alice获取candidate消息时，她调用addIceCandidate()，将candidate添加到远程对等描述中。</li>
</ol>
<p><img src="/images/web-rtc/connection-full.png" alt></p>
<h1 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h1><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/WebRTC_API" target="_blank" rel="noopener">WebRTC API</a></p>
<p><a href="https://blog.csdn.net/shaosunrise/article/details/83627828" target="_blank" rel="noopener">WebRTC中的信令和内网穿透技术 STUN / TURN</a></p>
<p><a href="https://www.cnblogs.com/pannengzhi/p/5061674.html" target="_blank" rel="noopener">P2P通信标准协议(三)之ICE</a></p>
<p><a href="https://www.cnblogs.com/mlgjb/p/8243690.html" target="_blank" rel="noopener">P2P技术详解(三)：P2P技术之STUN、TURN、ICE详解</a></p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2020-05-18</span><i class="fa fa-tag"></i><a class="tag" href="/tags/前端技术/" title="前端技术">前端技术 </a><a class="tag" href="/tags/P2P/" title="P2P">P2P </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,https://www.lemonkun.wang/2020/05/18/web-rtc/,绝好调超,WebRTC技术原理,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2020/06/03/sip/" title="SIP.js实现Web电话">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2020/04/02/autocomplete/" title="如何去掉浏览器的自动填充">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>