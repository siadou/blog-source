<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author"><title>无头浏览器初探 · 绝好调超</title><meta name="description" content="无头浏览器是浏览器一种新模式，该模式下用户可以完全通过命令行运行浏览器。前端早期对headless的支持实现是PhantomJS和selenium-webdriver，2017年谷歌宣布推出Chrome headless模式和Puppeteer，随后PhantomJS 和 Selenium IDE "><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><meta name="generator" content="Hexo 5.4.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">绝好调超</a></h3></div></div><ul class="social-links"></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a target="_blank" rel="noopener" href="https://www.caicai.me"> CaiCai </a><span>&</span><a target="_blank" rel="noopener" href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/about">关于</a></li><li><a href="/archives">归档</a></li><li><a href="/links">友链</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>无头浏览器初探</a></h3></div><div class="post-content"><p>无头浏览器是浏览器一种新模式，该模式下用户可以完全通过命令行运行浏览器。前端早期对headless的支持实现是PhantomJS和selenium-webdriver，2017年谷歌宣布推出Chrome headless模式和Puppeteer，随后PhantomJS 和 Selenium IDE for Firefox 作者宣布停止维护各自的项目。（内心OS： 你叫我们和人家专业做浏览器的怎么比。。。。。）Chrome 从 v59开始支持无头模式。支持所有Chromium和Blink的所有功能。无头浏览器在自动化测试、页面爬虫、批量截图、检测网络性能等领域都有广泛的应用。</p>
<p>对于爬虫而言，以往的爬虫需要关注数据报文、页面结构或者模拟发包，有了无头浏览器之后，只需要关注用户交互即可。</p>
<p>对于SPA（单页面应用）而言，由于页面内容通常用JS动态生成，爬虫和自动化流程都相对复杂。使用无头浏览器之后，因为能够模拟出整个页面的渲染，不用担心页面的结构变化问题。</p>
<p>使用无头浏览器，甚至可以追踪页面性能，输出数据，方便开发人员进行分析。</p>
<h1 id="Chrome无头模式"><a href="#Chrome无头模式" class="headerlink" title="Chrome无头模式"></a>Chrome无头模式</h1><h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><ul>
<li><p>MacOS下升级chrome到60以上</p>
</li>
<li><p>alias配置：</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">alias chrome&#x3D;&quot;&#x2F;Applications&#x2F;Google\ Chrome.app&#x2F;Contents&#x2F;MacOS&#x2F;Google\ Chrome&quot;</span><br><span class="line"># Chrome canary版</span><br><span class="line">alias chrome-canary&#x3D;&quot;&#x2F;Applications&#x2F;Google\ Chrome\ Canary.app&#x2F;Contents&#x2F;MacOS&#x2F;Google\ Chrome\ Canary&quot;</span><br><span class="line"># Chromium</span><br><span class="line">alias chromium&#x3D;&quot;&#x2F;Applications&#x2F;Chromium.app&#x2F;Contents&#x2F;MacOS&#x2F;Chromium&quot;</span><br></pre></td></tr></table></figure>

<h2 id="实验开始"><a href="#实验开始" class="headerlink" title="实验开始"></a>实验开始</h2><p>1 基本功能</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chrome --headless --remote-debugging-port&#x3D;9222 --crash-dumps-dir&#x3D;&#x2F;tmp </span><br></pre></td></tr></table></figure>

<p>打开远程调试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chrome --headless --crash-dumps-dir&#x3D;&#x2F;tmp --dump-dom https:&#x2F;&#x2F;www.baidu.com</span><br></pre></td></tr></table></figure>

<p>输出站点的dom结构，此时不能启用remote debug功能。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chrome --headless --crash-dumps-dir&#x3D;&#x2F;tmp --screenshot --window-size&#x3D;1280,1696 https:&#x2F;&#x2F;www.baidu.com</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>输出站点的截图。</p>
<p>2 REPL mode (read-eval-print loop)<br>加上–repl参数后，可以在命令行里运行JS表达式（类似于浏览器的Console）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ chrome --headless --repl --crash-dumps-dir&#x3D;.&#x2F;tmp </span><br><span class="line">&gt;&gt;&gt; location.href</span><br><span class="line">&#123;&quot;result&quot;:&#123;&quot;type&quot;:&quot;string&quot;,&quot;value&quot;:&quot;https:&#x2F;&#x2F;www.baidu.com&#x2F;&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>


<h1 id="Puppeter"><a href="#Puppeter" class="headerlink" title="Puppeter"></a>Puppeter</h1><p>Puppeter是Chrome团队开发的一个Node libary，可以通过DevTools Protocol调用Chrome，默认运行于headless模式下，也可以通过配置修改运行于完整模式下。</p>
<h2 id="环境准备-1"><a href="#环境准备-1" class="headerlink" title="环境准备"></a>环境准备</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm i puppeteer</span><br></pre></td></tr></table></figure>

<p>下载puppeteer会默认下载新版的Chromium（体积很大）。如果已经安装，可以通过配置环境变量跳过这一步骤。</p>
<h2 id="实验开始-1"><a href="#实验开始-1" class="headerlink" title="实验开始"></a>实验开始</h2><p>为了体验puppeteer的功能，我写了个简单的脚本，实现了某discuz论坛的自动签到功能。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> puppeteer = <span class="built_in">require</span>(<span class="string">&#x27;puppeteer&#x27;</span>);</span><br><span class="line"><span class="comment">// const devices = require(&#x27;puppeteer/DeviceDescriptors&#x27;);</span></span><br><span class="line"><span class="comment">// const iPhone = devices[&#x27;iPhone 6&#x27;];</span></span><br><span class="line"><span class="comment">// 模拟移动设备</span></span><br><span class="line"></span><br><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.launch(&#123;</span><br><span class="line">    <span class="comment">// headless: false,</span></span><br><span class="line">    <span class="comment">// 关闭无头模式，打开浏览器页面，调试用</span></span><br><span class="line">    <span class="comment">// executablePath: &#x27;/path/to/Chrome&#x27;,</span></span><br><span class="line">    <span class="comment">// 如果在安装puppeteer的时候跳过了安装chrominum，可通过指定改路径创建浏览器实例</span></span><br><span class="line">    <span class="comment">// slowMo: 250 </span></span><br><span class="line">    <span class="comment">// 减慢浏览器渲染速度slow down by 250ms</span></span><br><span class="line">    timeout: <span class="number">50000</span></span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line">  page.setDefaultNavigationTimeout(<span class="number">50000</span>)</span><br><span class="line">  page.on(<span class="string">&#x27;console&#x27;</span>, <span class="function"><span class="params">msg</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">&#x27;PAGE LOG:&#x27;</span>, msg.text()));</span><br><span class="line">  <span class="comment">// 捕获事件，获得console输出</span></span><br><span class="line">  <span class="comment">// await page.emulate(iPhone);</span></span><br><span class="line">  <span class="comment">// 模拟IPHONE 6</span></span><br><span class="line">  <span class="keyword">await</span> page.goto(<span class="string">&#x27;http://HOSTNAME/forum.php&#x27;</span>, &#123; <span class="attr">waitUntil</span>: <span class="string">&#x27;networkidle0&#x27;</span>&#125;);</span><br><span class="line">  <span class="keyword">let</span> loginres = <span class="keyword">await</span> page.evaluate(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> !!<span class="built_in">document</span>.querySelector(<span class="string">&#x27;a[href=&quot;home.php?mod=space&amp;amp;uid=USERID&quot;]&#x27;</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;loginres&#x27;</span>)</span><br><span class="line">  <span class="comment">// 检查是否登录</span></span><br><span class="line">  <span class="keyword">if</span> (!loginres) &#123;</span><br><span class="line">    <span class="keyword">await</span> page.click(<span class="string">&quot;a[href=&#x27;member.php?mod=logging&amp;action=login&#x27;]&quot;</span>, &#123; <span class="attr">delay</span>: <span class="number">200</span> &#125;);</span><br><span class="line">    <span class="keyword">await</span> page.waitForSelector(<span class="string">&#x27;input[name=username]&#x27;</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;get loginres&#x27;</span>)</span><br><span class="line">    <span class="keyword">await</span> page.type(<span class="string">&#x27;input[name=username]&#x27;</span>, <span class="string">&#x27;USERNAME&#x27;</span>);</span><br><span class="line">    <span class="keyword">await</span> page.type(<span class="string">&#x27;input[name=password]&#x27;</span>, <span class="string">&#x27;PASSWORD&#x27;</span>);</span><br><span class="line">    <span class="keyword">await</span> page.click(<span class="string">&#x27;.pc&#x27;</span>, &#123; <span class="attr">delay</span>: <span class="number">200</span> &#125;);</span><br><span class="line">    <span class="keyword">const</span> navigationPromise = page.waitForNavigation(&#123; <span class="attr">waitUntil</span> : <span class="string">&#x27;networkidle0&#x27;</span> &#125;)</span><br><span class="line">    <span class="keyword">await</span> page.click(<span class="string">&#x27;button.pn.pnc&#x27;</span>,  &#123; <span class="attr">delay</span>: <span class="number">200</span> &#125;);</span><br><span class="line">    <span class="comment">// login</span></span><br><span class="line">    <span class="keyword">await</span> navigationPromise;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// sign</span></span><br><span class="line">  <span class="keyword">await</span> page.goto(<span class="string">&#x27;http://HOSTNAME/plugin.php?id=XXXXsign:sign&#x27;</span>, &#123; <span class="attr">waitUntil</span>: <span class="string">&#x27;networkidle0&#x27;</span>&#125;);</span><br><span class="line">  <span class="keyword">await</span> page.click(<span class="string">&#x27;li#kx&#x27;</span>)</span><br><span class="line">  <span class="keyword">await</span> page.type(<span class="string">&#x27;input[name=todaysay]&#x27;</span>, <span class="string">&#x27;签到啦&#x27;</span>)</span><br><span class="line">  <span class="keyword">await</span> page.click(<span class="string">&#x27;img[src=&quot;source/plugin/XXXXsign/img/qdtb.gif&quot;]&#x27;</span>)</span><br><span class="line">  <span class="keyword">await</span> page.waitForNavigation(&#123; <span class="attr">waitUntil</span> : <span class="string">&#x27;networkidle0&#x27;</span> &#125;)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;finish&#x27;</span>)</span><br><span class="line">  <span class="keyword">await</span> browser.close();</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>相比于模拟发送报文的自动签到插件效率确实低了点，但是实现更简单直观不是吗（doge脸）</p>
<p>官网调试技巧，可以关掉浏览器的headless模式，这样调试更直接。</p>
<h1 id="问题总结"><a href="#问题总结" class="headerlink" title="问题总结"></a>问题总结</h1><p>1 MacOS下执行指令之后setxattr报错：<code>Operation not permitted</code></p>
<p>在指令中增加参数<code>--crash-dumps-dir=/tmp</code>即可。初始化时执行setxattr org.chromium.crashpad.database.initialized on file /var/folders/xxxxxxxxx，<br>因为新版MacOS增加了SIP(System Integrity Protection)功能，导致许多目录如/var目录无法读写。通过设置目录到/tmp可解决，也可以通过关掉SIP解决该问题。</p>
<p>参考链接：</p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/49103799/running-chrome-in-headless-mode">https://stackoverflow.com/questions/49103799/running-chrome-in-headless-mode</a></p>
<p><a target="_blank" rel="noopener" href="https://superuser.com/questions/1292863/chrome-crashpad-crashes-on-xattr/1307573">https://superuser.com/questions/1292863/chrome-crashpad-crashes-on-xattr/1307573</a></p>
<p>2 Puppeteer 中 evaluate 执行一个script脚本注入的全局函数报错。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Evaluation failed: TypeError: &#39;caller&#39;, &#39;callee&#39;, and &#39;arguments&#39; properties may not beaccessed on strict mode functions or the arguments objects for calls to them</span><br></pre></td></tr></table></figure>

<p>全局函数里有arguments的调用，puppeteer 的 evaluate 默认函数都是严格模式，不能调用caller、arguments、callee。（因为这个函数内部实现对外隐藏，最开始对puppeteer不熟悉，试了一阵子才反应过来是函数本身的问题。。）</p>
<p>3 Puppeteer 中的 evaluate 执行需要的所有参数都只能通过evaluate的参数传入，不能获得外面的变量。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; page.evaluate(pageFunction, ...args)</span><br><span class="line">&#x2F;&#x2F; 参数只能通过args传入，结果只能通过pageFunction的return传出</span><br><span class="line">&#x2F;&#x2F; 例子</span><br><span class="line">const result &#x3D; await page.evaluate(x &#x3D;&gt; &#123;</span><br><span class="line">  return Promise.resolve(8 * x;</span><br><span class="line">&#125;, 7)</span><br><span class="line">console.log(result); &#x2F;&#x2F; prints &quot;56&quot;</span><br></pre></td></tr></table></figure>


<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><p>headless-chrome</p>
<p><a target="_blank" rel="noopener" href="https://developers.google.cn/web/updates/2017/04/headless-chrome">https://developers.google.cn/web/updates/2017/04/headless-chrome</a></p>
<p>devtools-protocol</p>
<p><a target="_blank" rel="noopener" href="https://chromedevtools.github.io/devtools-protocol/">https://chromedevtools.github.io/devtools-protocol/</a></p>
<p>puppeteer API 文档(1.7)</p>
<p><a target="_blank" rel="noopener" href="https://github.com/GoogleChrome/puppeteer/blob/v1.7.0/docs/api.md">https://github.com/GoogleChrome/puppeteer/blob/v1.7.0/docs/api.md</a></p>
<h1 id="附注"><a href="#附注" class="headerlink" title="附注"></a>附注</h1><p>调试http接口：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">获取当前所有可调式页面信息</span><br><span class="line">http:&#x2F;&#x2F;127.0.0.1:9222&#x2F;json</span><br><span class="line"></span><br><span class="line">获取调试目标 WebView&#x2F;blink 的版本号</span><br><span class="line">http:&#x2F;&#x2F;127.0.0.1:9222&#x2F;json&#x2F;version</span><br><span class="line"></span><br><span class="line">创建新的 tab，并加载 url</span><br><span class="line">http:&#x2F;&#x2F;127.0.0.1:9222&#x2F;json&#x2F;new?url</span><br><span class="line"></span><br><span class="line">关闭 id 对应的 tab</span><br><span class="line">http:&#x2F;&#x2F;127.0.0.1:9222&#x2F;json&#x2F;close&#x2F;id</span><br><span class="line"></span><br><span class="line">切换到目标Tab</span><br><span class="line">http:&#x2F;&#x2F;127.0.0.1:9222&#x2F;json&#x2F;activate&#x2F;69301801-d503-42a3-9335-3e448a780857 : </span><br></pre></td></tr></table></figure>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2018-08-30</span><i class="fa fa-tag"></i><a class="tag" href="/tags/前端技术/" title="前端技术">前端技术 </a><a class="tag" href="/tags/Headless-Chrome/" title="Headless-Chrome">Headless-Chrome </a><a class="tag" href="/tags/Puppeter/" title="Puppeter">Puppeter </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,https://www.lemonkun.wang/2018/08/30/navigator-headless/,绝好调超,无头浏览器初探,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2019/09/27/hello-world/" title="Hello World">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2018/08/20/webpack-cache/" title="webpack持久化缓存相关笔记">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>